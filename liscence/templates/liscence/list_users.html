{%extends 'liscence/base.html'%} {%load static%} {%block head%}
<style>
  .modal-backdrop {
    display: none;
  }
</style>
{%endblock%}

{%block content%}

<div class="container">
<div style="display:flex;font-size:20px;margin-bottom:10px;">
  <div style="background:blue;color:white;padding:0 10px;flex:100%;"><b>Users</b></div>
    <div style="margin-left:10%"><a href="{%url 'create_user'%}" type="button" class="btn btn-primary">Add User</a></div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="table-responsive">
        <table id="mytable" class="table table-bordred table-striped">
          <thead>
            <th>Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Contact</th>
            <th>Submits</th>
            <th>Edit</th>
            <th>Delete</th>
          </thead>

          <tbody>
            {%for user in users%}
            <tr>
              <td class="udisplayName">{{user.display_name}}</td>
              <td class="uuid">{{user.uid}}</td>
              <td class="uemail">{{user.email}}</td>
              <td class="uphNumber">{{user.phone_number}}</td>
              <td>10</td>

              <td>
                <p data-placement="top" data-toggle="tooltip" title="Edit">
                  <button
                    class="btn btn-primary btn-xs"
                    data-title="Edit"
                    data-toggle="modal"
                    data-target="#editModal"
                    id="editUser"
                  >
                    <span class="glyphicon glyphicon-pencil"></span>
                  </button>
                </p>
              </td>

              <td>
                <p data-placement="top" data-toggle="tooltip" title="Delete">
                  <button
                    class="btn btn-danger btn-xs"
                    data-title="Delete"
                    data-toggle="modal"
                    data-target="#delete"
                    id="deleteUser"
                  >
                    <span class="glyphicon glyphicon-trash"></span>
                  </button>
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div
  class="modal fade"
  id="editModal"
  role="dialog"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Update User</h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <input hidden name='uid' class="form-control"/>
        </div>
        <div class="form-group">
          Display Name
          <input name='displayName' class="form-control" type="text"/>
        </div>
        <div class="form-group">
          Email
          <input name='email' class="form-control" type="text"  />
        </div>
        <div class="form-group">
          Contact
          <input name='contact' class="form-control" type="text"/>
        </div>

        <div class="form-group">
            <input name="checkStaff" type="checkbox" class="input-group-text" id="staffCheck">
            Staff
        </div>
      </div>

      <div class="modal-footer">
        <button id="closeChanges"  type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
        <button id='saveChanges' type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $(document).on("click", "#editUser", function () {
      var details = $(this).parents("tr");
      var uid = details.find(".uuid").html();
      var email = details.find(".uemail").html();
      var displayName = details.find(".udisplayName").html();
      var phNumber = details.find(".uphNumber").html();
        if (phNumber==='None')
          phNumber='';


      $('input[name="uid"]').val(uid);
      $('input[name="email"]').val(email);
      $('input[name="displayName"]').val(displayName);
      $('input[name="contact"]').val(phNumber);



      $("#saveChanges").click(function(){
        uid=$('input[name="uid"]').val();
        email=$('input[name="email"]').val();
        displayName=$('input[name="displayName"]').val();
        phNumber=$('input[name="contact"]').val();

        $.ajax({
          type:'POST',
          url:'{%url "user_update"%}',
          data:{'uid':uid,
                'email':email,
                'displayName':displayName,
                'phNumber':phNumber,
                'csrfmiddlewaretoken':'{{csrf_token}}',
          },
          dataType:'json',
          success: function(data){
            if (data.updated){
              details.find(".uemail").html(email);
              details.find(".udisplayName").html(displayName);
              details.find(".uphNumber").html(phNumber);

              $("#editModal").modal('hide');
              alert('Successfully Updated '+uid);
            }else
              alert(data.error);
          },
        });
      });

      $("#saveChanges").click(function(){
        $("#editModal").modal('dispose')
      });
    });

    $(document).on("click", "#deleteUser", function () {
      var details = $(this).parents("tr");
      var uid = details.find(".uuid").html();
      var recheck=confirm('Are you sure you want to delete this user "'+uid+'"');
      if (recheck==true){
        $.ajax({
          type:'POST',
          url:'{%url "user_delete"%}',
          data:{'uid':uid,
                'csrfmiddlewaretoken':'{{csrf_token}}',
          },
          dataType:'json',
          success: function(data){
            if (data.deleted){
              details.remove();
            }else
              alert("Could not be deleted. \nSomething might be went wrong.");
          },
        });
      }
    });
  });
</script>

{%endblock%}

